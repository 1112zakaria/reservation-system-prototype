generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// Core auth / RBAC entities
//

model User {
  id           String      @id @default(cuid())
  username     String      @unique
  email        String      @unique
  passwordHash String
  roles        UserRole[]

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

model Role {
  id        String     @id @default(cuid())
  name      String     @unique
  userRoles UserRole[]
}

model UserRole {
  id     String @id @default(cuid())
  userId String
  roleId String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
}

//
// Event template & scheduling
//

model Resource {
  id          String          @id @default(cuid())
  name        String
  description String?

  // Slot configuration
  slotMinutes Int             @default(30) // per-slot duration
  capacity    Int             @default(1)  // per-slot capacity (max clients)

  // Extended template fields (align with conceptual EventTemplate)
  location                String?
  timezone                String         @default("UTC")
  status                  ResourceStatus @default(DRAFT)
  startDate               DateTime?
  endDate                 DateTime?
  recurrenceIntervalWeeks Int            @default(1)
  daysOfWeek              String?        // e.g. "1,3,5" (Mon,Wed,Fri)
  eventStartTime          String?        // "09:00"
  eventEndTime            String?        // "17:00"
  slotGapMinutes          Int            @default(0)
  maxClientsPerSlotOverride Int?         // optional override of capacity per slot

  rules        AvailabilityRule[]
  reservations Reservation[]
  exceptions   EventException[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

enum ResourceStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model AvailabilityRule {
  id         String   @id @default(cuid())
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  weekday    Int
  startTime  String   // "09:00"
  endTime    String   // "17:00"
  isBlackout Boolean  @default(false)
  date       DateTime?

  createdAt  DateTime @default(now())
}

model EventException {
  id         String   @id @default(cuid())
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  date       DateTime
  kind       String   // "cancelled" | "modified" (free-form for now)
  payload    String?  // JSON with modification details, if any

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([resourceId, date])
}

//
// Bookings
//

model Reservation {
  id            String            @id @default(cuid())
  resourceId    String
  resource      Resource          @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  startAt       DateTime
  endAt         DateTime
  status        ReservationStatus @default(BOOKED)

  customerName  String
  customerEmail String?
  notes         String?

  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([resourceId, startAt])
  @@unique([resourceId, startAt])
}

enum ReservationStatus {
  BOOKED
  CANCELLED
  NO_SHOW
}
